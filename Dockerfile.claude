# =============================================================================
# Dockerfile for Claude Code Integration Testing
# Includes: agent-collab daemon + Claude Code CLI
# =============================================================================

# -----------------------------------------------------------------------------
# Build stage for agent-collab
# -----------------------------------------------------------------------------
FROM golang:latest AS builder

RUN apt-get update && apt-get install -y --no-install-recommends git ca-certificates && rm -rf /var/lib/apt/lists/*

WORKDIR /build

COPY go.mod go.sum ./
RUN go mod download

COPY . .

ARG VERSION=dev
ARG COMMIT=unknown
ARG DATE=unknown
ARG TARGETARCH

# Build for the target architecture (auto-detected by Docker buildx)
RUN CGO_ENABLED=0 GOOS=linux GOARCH=${TARGETARCH:-amd64} go build \
    -ldflags "-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.date=${DATE}" \
    -o /app/agent-collab ./src

# -----------------------------------------------------------------------------
# Runtime stage with Claude Code
# -----------------------------------------------------------------------------
FROM node:22-alpine

# Install dependencies (jq required for hooks)
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    bash \
    curl \
    git \
    jq

# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Create user
RUN adduser -D -g '' agent

# Copy agent-collab binary
COPY --from=builder /app/agent-collab /usr/local/bin/agent-collab
RUN chmod +x /usr/local/bin/agent-collab

# Verify binary works (will fail build early if architecture mismatch)
RUN agent-collab version || (echo "Binary architecture mismatch!" && exit 1)

# Create directories
RUN mkdir -p /data /workspace /home/agent/.claude && \
    chown -R agent:agent /data /workspace /home/agent

# Install agent-collab plugin (Claude Code will auto-detect plugins in ~/.claude/plugins/)
COPY --chown=agent:agent plugin/ /home/agent/.claude/plugins/local/agent-collab/

# Make hook scripts executable
RUN chmod +x /home/agent/.claude/plugins/local/agent-collab/hooks/*.mjs 2>/dev/null || true

# Setup MCP configuration in settings.json
# Claude Code reads ~/.claude/settings.json for MCP server registration
RUN cat > /home/agent/.claude/settings.json << 'EOF'
{
  "mcpServers": {
    "agent-collab": {
      "command": "/usr/local/bin/agent-collab",
      "args": ["mcp", "serve"],
      "env": {}
    }
  },
  "permissions": {
    "allow": [
      "mcp__agent-collab__*",
      "Bash(*)",
      "Read(*)",
      "Edit(*)",
      "Write(*)",
      "Glob(*)",
      "Grep(*)",
      "LS(*)"
    ]
  }
}
EOF
RUN chown agent:agent /home/agent/.claude/settings.json

# Copy startup script
COPY --chmod=755 scripts/docker-entrypoint.sh /usr/local/bin/docker-entrypoint

USER agent
WORKDIR /workspace

ENTRYPOINT ["docker-entrypoint"]
CMD ["idle"]
