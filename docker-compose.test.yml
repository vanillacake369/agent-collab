# Docker Compose for E2E Testing
# 3-node agent-collab cluster for integration testing

services:
  # Bootstrap node (cluster leader)
  peer1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agent-collab-peer1
    hostname: peer1
    environment:
      - AGENT_COLLAB_PEER_ID=peer1
      - AGENT_COLLAB_LISTEN_ADDR=/ip4/0.0.0.0/tcp/9000
      - AGENT_COLLAB_DATA_DIR=/data
      - AGENT_COLLAB_BOOTSTRAP=true
    volumes:
      - peer1-data:/data
    networks:
      collab-net:
        ipv4_address: 172.28.0.10
    ports:
      - "9001:9000"
    healthcheck:
      test: ["CMD", "/app/agent-collab", "status"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Peer node 2
  peer2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agent-collab-peer2
    hostname: peer2
    environment:
      - AGENT_COLLAB_PEER_ID=peer2
      - AGENT_COLLAB_LISTEN_ADDR=/ip4/0.0.0.0/tcp/9000
      - AGENT_COLLAB_DATA_DIR=/data
      - AGENT_COLLAB_BOOTSTRAP_PEERS=/ip4/172.28.0.10/tcp/9000/p2p/peer1
    volumes:
      - peer2-data:/data
    networks:
      collab-net:
        ipv4_address: 172.28.0.11
    depends_on:
      peer1:
        condition: service_healthy

  # Peer node 3
  peer3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agent-collab-peer3
    hostname: peer3
    environment:
      - AGENT_COLLAB_PEER_ID=peer3
      - AGENT_COLLAB_LISTEN_ADDR=/ip4/0.0.0.0/tcp/9000
      - AGENT_COLLAB_DATA_DIR=/data
      - AGENT_COLLAB_BOOTSTRAP_PEERS=/ip4/172.28.0.10/tcp/9000/p2p/peer1
    volumes:
      - peer3-data:/data
    networks:
      collab-net:
        ipv4_address: 172.28.0.12
    depends_on:
      peer1:
        condition: service_healthy

networks:
  collab-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  peer1-data:
  peer2-data:
  peer3-data:
