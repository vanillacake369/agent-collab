name: Update APT Repository

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  update-apt-repo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Setup GPG
        run: |
          echo "${{ secrets.APT_GPG_PRIVATE_KEY }}" | gpg --import

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p apt/pool/main
          gh release download ${{ github.event.release.tag_name }} \
            --pattern "*.deb" \
            --dir apt/pool/main

      - name: Generate APT repository metadata
        run: |
          cd apt
          mkdir -p dists/stable/main/binary-amd64
          mkdir -p dists/stable/main/binary-arm64

          # Generate Packages files
          dpkg-scanpackages --arch amd64 pool/ > dists/stable/main/binary-amd64/Packages
          dpkg-scanpackages --arch arm64 pool/ > dists/stable/main/binary-arm64/Packages

          gzip -k -f dists/stable/main/binary-amd64/Packages
          gzip -k -f dists/stable/main/binary-arm64/Packages

          # Generate Release file
          cd dists/stable
          cat > Release << EOF
          Origin: agent-collab
          Label: agent-collab
          Suite: stable
          Codename: stable
          Architectures: amd64 arm64
          Components: main
          Description: agent-collab APT repository
          EOF

          apt-ftparchive release . >> Release

          # Sign Release file
          gpg --default-key "${{ secrets.APT_GPG_KEY_ID }}" -abs -o Release.gpg Release
          gpg --default-key "${{ secrets.APT_GPG_KEY_ID }}" --clearsign -o InRelease Release

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apt
          destination_dir: apt
          keep_files: true
